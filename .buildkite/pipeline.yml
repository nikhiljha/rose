env:
  CARGO_TERM_COLOR: "always"
  RUSTFLAGS: "-Dwarnings"

cache:
  paths:
    - target

steps:
  - label: ":memo: Format"
    command: cargo fmt --all -- --check
    if_changed:
      - "**.rs"
      - Cargo.toml
      - Cargo.lock
    plugins:
      - docker#v5.11.0:
          image: "ghcr.io/nikhiljha/rose-ci:latest"
          mount-checkout: true

  - label: ":lint-roller: Clippy"
    command: cargo clippy --workspace --all-targets
    if_changed:
      - "**.rs"
      - Cargo.toml
      - Cargo.lock
    plugins:
      - docker#v5.11.0:
          image: "ghcr.io/nikhiljha/rose-ci:latest"
          mount-checkout: true

  - label: ":bar_chart: Coverage"
    commands:
      - cargo +nightly llvm-cov-easy nextest --workspace --branch
      - cargo test --workspace --doc
    if_changed:
      - "**.rs"
      - Cargo.toml
      - Cargo.lock
    plugins:
      - docker#v5.11.0:
          image: "ghcr.io/nikhiljha/rose-ci:latest"
          mount-checkout: true

  - label: ":shield: Security"
    command: cargo deny check
    if_changed:
      - Cargo.toml
      - Cargo.lock
      - deny.toml
    plugins:
      - docker#v5.11.0:
          image: "ghcr.io/nikhiljha/rose-ci:latest"
          mount-checkout: true

  - label: ":zap: Build & Deploy Site"
    if: build.branch == "main" && build.pull_request.id == null
    if_changed:
      - "**.rs"
      - "doc/**"
      - "site/**"
      - Cargo.toml
      - Cargo.lock
    commands:
      - bash site/build.sh
      - wrangler pages deploy site/public --project-name=rose --branch=main
    secrets:
      - CLOUDFLARE_API_TOKEN
      - CLOUDFLARE_ACCOUNT_ID
    plugins:
      - docker#v5.11.0:
          image: "ghcr.io/nikhiljha/rose-ci:latest"
          mount-checkout: true
          environment:
            - CLOUDFLARE_API_TOKEN
            - CLOUDFLARE_ACCOUNT_ID
